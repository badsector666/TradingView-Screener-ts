<![CDATA[<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TradingView Screener Interface</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }
        
        .form-container {
            padding: 40px;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-group.full-width {
            grid-column: 1 / -1;
        }
        
        label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
            font-size: 0.95rem;
        }
        
        input, select, textarea {
            padding: 12px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        textarea {
            resize: vertical;
            min-height: 100px;
            font-family: 'Monaco', 'Menlo', monospace;
        }
        
        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            max-height: 200px;
            overflow-y: auto;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            padding: 15px;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .checkbox-item input[type="checkbox"] {
            margin: 0;
            transform: scale(1.2);
        }
        
        .filter-section {
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .filter-section h3 {
            color: #2c3e50;
            margin-bottom: 15px;
        }
        
        .filter-row {
            display: grid;
            grid-template-columns: 2fr 1fr 2fr auto;
            gap: 10px;
            align-items: end;
            margin-bottom: 10px;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        
        .btn-secondary {
            background: #95a5a6;
            color: white;
        }
        
        .btn-danger {
            background: #e74c3c;
            color: white;
        }
        
        .btn-small {
            padding: 8px 16px;
            font-size: 0.9rem;
        }
        
        .results-container {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            display: none;
        }
        
        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .results-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .results-table th,
        .results-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e1e8ed;
        }
        
        .results-table th {
            background: #2c3e50;
            color: white;
            font-weight: 600;
        }
        
        .results-table tr:hover {
            background: #f8f9fa;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }
        
        .error {
            background: #fee;
            border: 1px solid #fcc;
            color: #c33;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
        }
        
        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .filter-row {
                grid-template-columns: 1fr;
            }
            
            .checkbox-group {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä TradingView Screener</h1>
            <p>Advanced Stock Screening Interface</p>
        </div>
        
        <div class="form-container">
            <form id="screenerForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="columns">Select Columns:</label>
                        <textarea id="columns" placeholder="name, close, volume, market_cap_basic, P/E, RSI">name, close, volume, market_cap_basic</textarea>
                        <small style="color: #7f8c8d; margin-top: 5px;">Comma-separated column names</small>
                    </div>
                    
                    <div class="form-group">
                        <label>Markets:</label>
                        <div id="marketsContainer" class="checkbox-group">
                            <!-- Markets will be populated dynamically -->
                        </div>
                    </div>
                </div>
                
                <div class="filter-section">
                    <h3>üîç Filters</h3>
                    <div id="filtersContainer">
                        <div class="filter-row">
                            <select class="filter-column">
                                <option value="">Select Column</option>
                                <option value="close">Close Price</option>
                                <option value="volume">Volume</option>
                                <option value="market_cap_basic">Market Cap</option>
                                <option value="P/E">P/E Ratio</option>
                                <option value="RSI">RSI</option>
                                <option value="change">Change %</option>
                            </select>
                            <select class="filter-operation">
                                <option value="gt">Greater Than</option>
                                <option value="gte">Greater Than or Equal</option>
                                <option value="lt">Less Than</option>
                                <option value="lte">Less Than or Equal</option>
                                <option value="eq">Equal To</option>
                                <option value="ne">Not Equal To</option>
                                <option value="between">Between</option>
                            </select>
                            <input type="text" class="filter-value" placeholder="Value">
                            <button type="button" class="btn btn-danger btn-small" onclick="removeFilter(this)">Remove</button>
                        </div>
                    </div>
                    <button type="button" class="btn btn-secondary btn-small" onclick="addFilter()">Add Filter</button>
                </div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label for="orderBy">Sort By:</label>
                        <select id="orderBy">
                            <option value="">No Sorting</option>
                            <option value="name">Name</option>
                            <option value="close">Close Price</option>
                            <option value="volume">Volume</option>
                            <option value="market_cap_basic">Market Cap</option>
                            <option value="change">Change %</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="orderDirection">Sort Direction:</label>
                        <select id="orderDirection">
                            <option value="false">Descending</option>
                            <option value="true">Ascending</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label for="limit">Limit Results:</label>
                        <input type="number" id="limit" value="50" min="1" max="1000">
                    </div>
                    
                    <div class="form-group">
                        <label for="offset">Offset:</label>
                        <input type="number" id="offset" value="0" min="0">
                    </div>
                </div>
                
                <div class="form-group full-width" style="margin-top: 30px;">
                    <button type="submit" class="btn btn-primary">üöÄ Execute Query</button>
                </div>
            </form>
            
            <div id="resultsContainer" class="results-container">
                <div class="results-header">
                    <h3 id="resultsTitle">Query Results</h3>
                    <span id="resultsCount"></span>
                </div>
                <div id="resultsContent">
                    <!-- Results will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let availableMarkets = [];
        
        // Initialize the application
        document.addEventListener('DOMContentLoaded', async function() {
            await loadMarkets();
            setupEventListeners();
        });
        
        // Load available markets from API
        async function loadMarkets() {
            try {
                const response = await fetch('/api/markets');
                const result = await response.json();
                
                if (result.success) {
                    availableMarkets = result.data;
                    populateMarkets();
                } else {
                    console.error('Failed to load markets');
                    // Fallback markets
                    availableMarkets = ['america', 'india', 'uk', 'germany', 'crypto', 'forex'];
                    populateMarkets();
                }
            } catch (error) {
                console.error('Error loading markets:', error);
                // Fallback markets
                availableMarkets = ['america', 'india', 'uk', 'germany', 'crypto', 'forex'];
                populateMarkets();
            }
        }
        
        // Populate markets checkboxes
        function populateMarkets() {
            const container = document.getElementById('marketsContainer');
            container.innerHTML = '';
            
            availableMarkets.forEach((market, index) => {
                const checkboxItem = document.createElement('div');
                checkboxItem.className = 'checkbox-item';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `market-${market}`;
                checkbox.value = market;
                checkbox.checked = market === 'america'; // Default to America
                
                const label = document.createElement('label');
                label.htmlFor = `market-${market}`;
                label.textContent = market.charAt(0).toUpperCase() + market.slice(1);
                label.style.margin = '0';
                label.style.cursor = 'pointer';
                
                checkboxItem.appendChild(checkbox);
                checkboxItem.appendChild(label);
                container.appendChild(checkboxItem);
            });
        }
        
        // Setup event listeners
        function setupEventListeners() {
            const form = document.getElementById('screenerForm');
            form.addEventListener('submit', handleFormSubmit);
        }
        
        // Add new filter row
        function addFilter() {
            const container = document.getElementById('filtersContainer');
            const filterRow = document.createElement('div');
            filterRow.className = 'filter-row';
            filterRow.innerHTML = `
                <select class="filter-column">
                    <option value="">Select Column</option>
                    <option value="close">Close Price</option>
                    <option value="volume">Volume</option>
                    <option value="market_cap_basic">Market Cap</option>
                    <option value="P/E">P/E Ratio</option>
                    <option value="RSI">RSI</option>
                    <option value="change">Change %</option>
                    <option value="EMA20">EMA 20</option>
                    <option value="SMA50">SMA 50</option>
                    <option value="MACD.macd">MACD</option>
                    <option value="MACD.signal">MACD Signal</option>
                </select>
                <select class="filter-operation">
                    <option value="gt">Greater Than</option>
                    <option value="gte">Greater Than or Equal</option>
                    <option value="lt">Less Than</option>
                    <option value="lte">Less Than or Equal</option>
                    <option value="eq">Equal To</option>
                    <option value="ne">Not Equal To</option>
                    <option value="between">Between</option>
                </select>
                <input type="text" class="filter-value" placeholder="Value">
                <button type="button" class="btn btn-danger btn-small" onclick="removeFilter(this)">Remove</button>
            `;
            container.appendChild(filterRow);
        }
        
        // Remove filter row
        function removeFilter(button) {
            const filterRow = button.closest('.filter-row');
            filterRow.remove();
        }
        
        // Handle form submission
        async function handleFormSubmit(event) {
            event.preventDefault();
            
            const resultsContainer = document.getElementById('resultsContainer');
            const resultsContent = document.getElementById('resultsContent');
            const resultsTitle = document.getElementById('resultsTitle');
            const resultsCount = document.getElementById('resultsCount');
            
            // Show loading state
            resultsContainer.style.display = 'block';
            resultsContent.innerHTML = '<div class="loading">üîÑ Executing query...</div>';
            
            try {
                // Collect form data
                const formData = collectFormData();
                
                // Send request to API
                const response = await fetch('/api/query', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    displayResults(result.data);
                } else {
                    displayError(result.error || 'Query execution failed');
                }
            } catch (error) {
                console.error('Request failed:', error);
                displayError('Network error: ' + error.message);
            }
        }
        
        // Collect form data
        function collectFormData() {
            // Get columns
            const columnsText = document.getElementById('columns').value.trim();
            const columns = columnsText ? columnsText.split(',').map(col => col.trim()) : ['name', 'close', 'volume', 'market_cap_basic'];
            
            // Get selected markets
            const marketCheckboxes = document.querySelectorAll('#marketsContainer input[type="checkbox"]:checked');
            const markets = Array.from(marketCheckboxes).map(cb => cb.value);
            
            // Get filters
            const filterRows = document.querySelectorAll('.filter-row');
            const filters = [];
            
            filterRows.forEach(row => {
                const column = row.querySelector('.filter-column').value;
                const operation = row.querySelector('.filter-operation').value;
                const value = row.querySelector('.filter-value').value;
                
                if (column && operation && value) {
                    let processedValue = value;
                    
                    // Handle between operation (expects array)
                    if (operation === 'between') {
                        const values = value.split(',').map(v => parseFloat(v.trim()));
                        if (values.length === 2 && !isNaN(values[0]) && !isNaN(values[1])) {
                            processedValue = values;
                        }
                    } else if (!isNaN(value)) {
                        // Convert to number if possible
                        processedValue = parseFloat(value);
                    }
                    
                    filters.push({
                        column,
                        operation,
                        value: processedValue
                    });
                }
            });
            
            // Get sorting options
            const orderBy = document.getElementById('orderBy').value;
            const orderDirection = document.getElementById('orderDirection').value === 'true';
            
            // Get pagination
            const limit = parseInt(document.getElementById('limit').value) || 50;
            const offset = parseInt(document.getElementById('offset').value) || 0;
            
            return {
                columns,
                markets: markets.length > 0 ? markets : ['america'],
                filters,
                orderBy: orderBy || undefined,
                orderDirection,
                limit,
                offset
            };
        }
        
        // Display query results
        function displayResults(data) {
            const resultsContent = document.getElementById('resultsContent');
            const resultsCount = document.getElementById('resultsCount');
            
            if (!data || !data.data || data.data.length === 0) {
                resultsContent.innerHTML = '<div class="loading">No results found</div>';
                resultsCount.textContent = '0 results';
                return;
            }
            
            // Update count
            resultsCount.textContent = `${data.totalCount || data.data.length} results`;
            
            // Create table
            const table = document.createElement('table');
            table.className = 'results-table';
            
            // Create header
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            
            // Get column names from first result
            const firstResult = data.data[0];
            const columnNames = Object.keys(firstResult);
            
            columnNames.forEach(columnName => {
                const th = document.createElement('th');
                th.textContent = columnName.charAt(0).toUpperCase() + columnName.slice(1).replace(/_/g, ' ');
                headerRow.appendChild(th);
            });
            
            thead.appendChild(headerRow);
            table.appendChild(thead);
            
            // Create body
            const tbody = document.createElement('tbody');
            
            data.data.forEach(row => {
                const tr = document.createElement('tr');
                
                columnNames.forEach(columnName => {
                    const td = document.createElement('td');
                    const value = row[columnName];
                    
                    // Format value based on type
                    if (typeof value === 'number') {
                        if (columnName.includes('cap') || columnName.includes('volume')) {
                            // Format large numbers
                            td.textContent = formatLargeNumber(value);
                        } else {
                            // Format regular numbers
                            td.textContent = value.toLocaleString();
                        }
                    } else {
                        td.textContent = value || '-';
                    }
                    
                    tr.appendChild(td);
                });
                
                tbody.appendChild(tr);
            });
            
            table.appendChild(tbody);
            resultsContent.innerHTML = '';
            resultsContent.appendChild(table);
        }
        
        // Display error message
        function displayError(message) {
            const resultsContent = document.getElementById('resultsContent');
            resultsContent.innerHTML = `<div class="error">‚ùå Error: ${message}</div>`;
        }
        
        // Format large numbers (e.g., market cap, volume)
        function formatLargeNumber(num) {
            if (num >= 1e12) {
                return (num / 1e12).toFixed(2) + 'T';
            } else if (num >= 1e9) {
                return (num / 1e9).toFixed(2) + 'B';
            } else if (num >= 1e6) {
                return (num / 1e6).toFixed(2) + 'M';
            } else if (num >= 1e3) {
                return (num / 1e3).toFixed(2) + 'K';
            }
            return num.toLocaleString();
        }
    </script>
</body>
</html>